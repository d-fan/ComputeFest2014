#pragma once

#include <cstdlib>
#include <cstdio>

#include <iostream>
#include <iomanip>
#include <string>
#include <vector>

#include <sstream>
#include <iterator>

#include <cmath>
#include <cassert>
#include <cstring>

#include <unistd.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <netdb.h>

using namespace std;

const int STATE_SIZE  = 4;
const int STATE_DIM   = 2;
const int STATE_NUM   = pow(STATE_SIZE, STATE_DIM);

const int MAX_MESSAGE_LENGTH = 1024;
const char DELIMITER = ' ';

template <typename IT>
vector<vector<int> > data2wall(IT begin, IT end) {
  vector<vector<int> > data;
  for (; begin < end; begin += STATE_SIZE)
    data.push_back(vector<int>(begin, begin + STATE_SIZE));
  return data;
}

vector<vector<int> > vector2wall(const vector<int>& v) {
  return data2wall(v.begin(), v.end());
}

vector<int> string2vector(const string& s) {
  vector<int> data;
  stringstream str(s);
  copy(istream_iterator<int>(str), istream_iterator<int>(),
            back_inserter(data));
  return data;
}


class Game {
 private:
  int comm;
  char buffer[MAX_MESSAGE_LENGTH];

  string recv() {
    int read_char = read(comm, buffer, MAX_MESSAGE_LENGTH);
    if (read_char == -1)
      cout << "READ ERROR" << endl;
    string s(buffer, read_char);
    if (s == string("")) {
      cout << "END" << endl;
      exit(0);
    }
    return s;
  }

  void send(const string& s) {
    if (write(comm, s.c_str(), s.size()) == -1)
      cout << "WRITE ERROR" << endl;
  }

 public:
  typedef vector<vector<int> > wall_type;
  wall_type wall;
  wall_type owall;

  Game(const string& game_id) {
    comm = socket(AF_INET, SOCK_STREAM, 0);
    memset(buffer, 0, MAX_MESSAGE_LENGTH);

    hostent* server = gethostbyname("crisco.seas.harvard.edu");
    //hostent* server = gethostbyname("localhost");
    if (server == NULL)
      cout << "No such host!" << endl;;

    sockaddr_in addr;
    memset((char*)&addr, 0, sizeof(addr));
    addr.sin_family = AF_INET;
    addr.sin_port = htons(8080);
    memcpy((char*)&addr.sin_addr.s_addr, (char*)server->h_addr, server->h_length);
    if (connect(comm, (sockaddr*)&addr, sizeof(addr)) < 0)
      cout << "Connection Error" << endl;

    send(game_id);
    cout << "Waiting for game " << recv() << endl;

    string message = recv();
    cout << message << endl;
    assert(message == string("READY"));

    // Receive our game wall
    wall = vector2wall(string2vector(recv()));
  }

  ~Game() {
    close(comm);
  }

  int get_discard() {
    string msg = recv();
    if (msg == string("LOSE")) {
      cout << "***" << msg << "***" << endl;
      exit(0);
    }
    vector<int> data = string2vector(msg);
    owall = data2wall(data.begin()+1, data.end());
    return data[0];
  }

  int get_brick(const string& move) {
    send(move);
    return atoi(recv().c_str());
  }

  void make_move(const string& move) {
    send(move);
    string msg = recv();
    if (msg == string("WIN")) {
      cout << "***" << msg << "***" << endl;
      exit(0);
    }
    wall = vector2wall(string2vector(msg));
  }
};
